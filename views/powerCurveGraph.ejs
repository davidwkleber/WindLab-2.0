	
			
	<div id="powerCurveContainer" >
	</div>
	


<script type="text/javascript" src="/javascripts/JSON2CSV.js"></script>
<script type="text/javascript" src="/javascripts/JSON2TSV.js"></script>
	<script type="text/javascript" src="/lib/canvasJS/canvasjs.min.js"></script>
		
	
  	<div class="PCsaveDataButtonDiv">
		<button class="PCsaveDataButton" id="PCsaveDataButton" name="PCsaveDataButton" onclick="PCsaveDataFunction()">Save</button>
	</div>
	<div class="PCrecordButtonsDiv" name="PCrecordButtonsDiv" id="PCrecordButtonsDiv" >
	</div>
	
 	<div class="PCrecordDataButtonDiv">
		<button class="PCrecordDataButton" id="PCrecordDataButton" name="PCrecordDataButton" onclick="PCrecordDataFunction()">Record</button>
	</div>
	
	<script type="text/javascript">
   
   function addWindPitchCurrentToData( sendData ) {

	 // send the incoming data to browser with websockets.
		if (sendData.length > 0 ) {
			var now = new Date();
			var formatNow = now.getDate()+"/"+(now.getMonth()+1)+"/"+now.getFullYear()+'\:'+now.getHours()+'\:'+now.getMinutes()+'\:'+now.getSeconds()+'\:'+now.getMilliseconds();
		
		/* use the same calculation for changin wind speed % to a m/s value
			this is from windsock.ejs. 
			Not the best I know, but hope it works, otherwise windSpeedValue was a percentage...
		*/
		var windSpeedValueText = reutrnWindSpeed(windSpeedValue);

		/* do the same for the pitch angle.
		*/
		var pitchAngleValueText = returnPitchAngle(pitchAngleValue);
		
		/* and dummy load
			NOTE, the magic number 201 is from DLnumFrames in the dummyLoad.ejs file
		*/
		var dummyLoadValueText = returnDummyLoad(dummyLoadValue);
		
			// console.log('SEND update data : '+sendData);
			
			//start with the date
			var sendJSON = '{\n  \"date\": \"'+formatNow+'\",';
			// put in the JSON from the serial input next
			sendJSON += sendData.substring(1, sendData.length-3);
			// now add the info local to the interface, wind speed, pitch angle and dummy load
			sendJSON += ",\n  \"windSpeed\": "+windSpeedValueText+",\n";
			sendJSON += "  \"pitchAngle\": "+pitchAngleValueText+",\n";
			sendJSON += "  \"dummyLoad\": "+dummyLoadValueText+"\n";
			sendJSON += "}";
			// have to parse the string sendJSON to a JSON object in order to adjust RPM
			dataItem = JSON.parse(sendJSON);
			// adjust RPM due to Arduino issues.
			dataItem.rpm = Math.floor(dataItem.rpm / 1000);
	
			// have to put JSON dataItem back into a string to send properly, why things cannot handle JSON objects???
		//	io.emit('updateData', JSON.stringify(dataItem));

		/*
			sendJSON = null;
			sendData = null;
			dummyLoadValueText = null;
			pitchAngleValueText = null;
			windSpeedValueText = null;
			now = null;
			receivedData = null;
			jsonClosed = null;
			jsonOpened = null;
		*/
			// console.log("in SerialListener: the wind speed: "+windSpeedValue);
			// console.log("in SerialListener: the pitch angle: "+pitchAngleValue);
			// console.log("in SerialListener: the dummy load: "+dummyLoadValue);

			return JSON.stringify(dataItem);
		};
		
		};
		
		
function reutrnWindSpeed( windSpeedValueIn ) {
		var windSpeedValueText = (windSpeedValueIn*0.1456)-0.5523;
		windSpeedValueText =  +(Math.round(windSpeedValueText +"e+1")+"e-1");
		if ( windSpeedValueText < 0 ) {
			windSpeedValueText = 0;
		}		
		return windSpeedValueText;
}	;	

function returnPitchAngle( pitchAngleIn ) {
	return  (pitchAngleIn-101)/10;
};

function returnDummyLoad( dummyLoadIn ) {
	var dummyLoadValueText = ((dummyLoadValue-1)/201)*100;
		dummyLoadValueText =  +(Math.round(dummyLoadValueText +"e+1")+"e-1");
	return dummyLoadValueText;
};

// window.onload = function () {
			var data = []; 
			var dataSeries = { type: "scatter" };
			 var meanDataSeries = {type: "line" };
			var dataPoints = [];
			var meanDataPoints = [];

			 meanData = []; 
			 
/*
			 meanData.push({
				x: 0,
				y: 0
			});
	*/		
			dataPoints.push({
				x: 0,
				y: 0
			});
				meanDataSeries.dataPoints = meanData;
		//		meanDataLine.push(meanDataSeries);
				
				 dataSeries.dataPoints = dataPoints;
				data.push(dataSeries);
				if (data.length > limit)
				{
					data.shift();				
				}
				if (dataSeries.length > limit)
				{
				dataSeries.shift();
				}
	//			console.log("data initalized");
				
				

		var chart = new CanvasJS.Chart("powerCurveContainer",
		{
			zoomEnabled: true,
			backgroundColor: null,
			title:{
				text: "Power Curve"
				},
				animationEnabled: true,

				axisY:{
				title: "Power mW",
				labelFontFamily: "sans-serif",
				labelFontSize: 10,
				 labelFontColor: "black",
				lineColor: "black",
				tickColor: "black",
					includeZero: false,
					minimum: 0,
					maximum: 600,
					interval: 250
				},
				axisX:{
				title: "RPM",
				labelFontFamily: "sans-serif",
				labelFontSize: 10,
				labelFontColor: "black",
				lineColor: "black",
				tickColor: "black",
					labelAngel: 30,
					minimum: 0,
					maximum: 5000,
					interval: 1000
				},
				// data: [meanDataLine, data]
				   data: [ meanDataSeries, dataSeries ]
		});
			
		 chart.render();
	//	}
		
			
		var limit = 1; //increase number of data Points by increasing this
		

		console.log("POWER CURVE GRAPH");
		
			var dataItem;
					// set of data for each meanData point calculation
			 inData = []; 
		var inData_limit = 1000;
			 outData = []; 
		
			
	
		function handlePowerCurveData(dataInFromStream) {
		
				// add the client based data to the data object
				dataIn = addWindPitchCurrentToData(dataInFromStream);

					// save the new JSON data to a buffer
					// this buffer is used for figuring which meanData to show
					inData.push(dataIn);
					if ( inData.length > inData_limit ) {
						inData.shift();
					}
					// console.log("inData size: "+inData.length);

			//		console.log("inData: "+inData);
					
			// the clear Rect would not work, so used the hack below with width=width
				 // context.clearRect(0, 0, chart.width, chart.height);
				chart.width = chart.width;

			//	console.log('powerCurve update: ' + dataIn);
				//	dataItem = JSON.parse(dataIn);
					dataItem = computeMean(inData);
						dataPoints.push({
							x: dataItem.rpm,
							y: dataItem.power,

						});
					if (dataPoints.length > limit)
					{
						dataPoints.shift();				
					}
			//	console.log("dataSeries pushed "+dataPoints.length);	
			//	var jsonObj = JSON.stringify(dataPoints);
			//	console.log("dataSeries pushed obj: "+jsonObj);
				
				 dataSeries.dataPoints = dataPoints;
				
			// context.clearRect(0, 0, chart.width, chart.height);
							chart.render();

		};
				
			dataSocket.on('updateData', handlePowerCurveData );

	//	});
		function PCrecordDataFunction() {
					console.log('record button in Power Curve: ');
					console.log("in RECORD inData size: "+inData.length);
					meanDataData(inData);
					console.log("in Record: meanDataPoint: "+JSON.stringify(meanData));
					console.log("in Record: meanDataSeries Point: "+JSON.stringify(dataSeries));

					outData.push(inData);
																//	console.log("in RECORD outData : "+outData);

					// inData = [];
							//	console.log("in RECORD inData size: "+outData.length);
							//	console.log("in RECORD inData size: "+outData);

							chart.render();


				}
				
	function PCsaveDataFunction() {
				// console.log('Save button in Power Curve: ');
					console.log("in SAVE inData size: "+outData.length);
				//	console.log("in SAVE outData : "+JSON.stringify(outData));															

			// var json = JSON.stringify(data);
			var json = outData;
		//	var blob = new Blob([json], {type: "application/json"});
			
			var tsv = JSON2TSV("["+json+"]");
			var blob = new Blob([tsv], {type: "application/csv"});
	
			var url = URL.createObjectURL(blob);
			
			var a = document.createElement('a');
			a.id = "saveDataLinkPlace";
			var date = new Date();
			var fileName = "PowerCurve_data."+date.getDate()+"-"+(date.getMonth()+1)+"-"+date.getFullYear()+" "+date.getHours()+"."+date.getMinutes()+".tsv";
			a.download = fileName;
			a.href = url;
			a.textContent = "Download data as JSON";
			
			saveAs(blob,fileName);
			meanData = [];
			outData = [];
			inData = [];
			console.log("save data");
meanDataSeries.dataPoints = meanData;
		}
		
		

		function meanDataData(dataTomeanData) {
				var sum = [];
			   var sumPower = 0;
			   var sumRPM = 0;
// console.log("dataTomeanData.length "+dataTomeanData.length);
				for(var i = 0; i < dataTomeanData.length; i++) {
// console.log("meanData: data to meanData: "+JSON.stringify(dataTomeanData[i]));
					
					thisDataItem = JSON.parse(dataTomeanData[i]);
							sumPower += dataItem.power;
							sumRPM += dataItem.rpm;

				};
				
				var y = (sumPower / dataTomeanData.length);
				var x = (sumRPM / dataTomeanData.length);

			meanData.push( {
				x: x,
				y: y
			});
											// console.log("meanData: meanData data length: "+meanData.length);
											//console.log("meanData power: "+x);
											 // console.log("meanData rpm: "+y);
											// console.log("meanData: meanData data : "+JSON.stringify(meanData));


		//	if ( meanData.length > 1 ) {
		//		meanData.shift();
		//	}
			meanDataSeries.dataPoints = meanData;
			console.log("meanData: "+JSON.stringify(meanData));
						
			console.log("meanDataSeries Line "+JSON.stringify(meanDataSeries));
			console.log("data current point "+JSON.stringify(data));

				

			}

	function computeMean(dataToMean) {
			var sum = [];
			   var sumPower = 0;
			   var sumRPM = 0;
// console.log("dataToMean.length "+dataToMean.length);
				for(var i = 0; i < dataToMean.length; i++) {
// console.log("meanData: data to mean: "+JSON.stringify(dataToMean[i]));
					
					thisDataItem = JSON.parse(dataToMean[i]);
							sumPower += dataItem.power;
							sumRPM += dataItem.rpm;

				};
				
				var y = (sumPower / dataToMean.length);
				var x = (sumRPM / dataToMean.length);
				
				thisDataItem.power = y;
				thisDataItem.rpm = x;
				
				return thisDataItem;
			}


		
		</script>

	
		
		
		
				